<html>
    <head>
        <link rel="stylesheet" type="text/css" href="gameComponents/mapSelector.css">
        <link rel="stylesheet" type="text/css" href="gameComponents/game.css">
        <script>
            
            window.mapSelector=(function(){
                
                var carousel=(function(){
                    var baseElement = null;
                    var currentIndex = 0;
                    var rotatorArray = [];
                    var imgKey = null;
                    var baseElementWidth = 0;
                    var animating = false;
                    
                    function rotateToIndex(index,direction){
                        if (direction !== left || direction !== "right"){
                            //determine quickest direction
                            if (currentIndex-index>rotatorArray.length/2){
                                direction="left";
                            }else{
                                direction="right"
                            }
                        }
                        var numSpins = 0;
                        if(direction=="left"){
                            numSpins = rotatorArray.length-Math.abs(currentIndex-index);
                            if (index>currentIndex){
                                numSpins = rotatorArray.length-(index-currentIndex);
                            }else{
                                numSpins = currentIndex-index;
                            }
                        }else{
                            
                            if (index<currentIndex){
                                numSpins = rotatorArray.length-(currentIndex-index);
                            }else{
                                numSpins = index-currentIndex;
                            }
                        }
                        
                        for (i=0;i<numSpins;i++){
                            if(direction=="left"){ 
                                rotateLeft(); 
                            }else{
                                rotateRight();
                            }
                        }
                    }
                    
                    function rotateLeft(){
                        if (animating == false){
                            animating=true
                            var nextIndex = currentIndex - 1;
                            if (nextIndex < 0){
                                nextIndex = rotatorArray.length+nextIndex;
                            }
                            var prevItem = rotatorArray[currentIndex];
                            var item = rotatorArray[nextIndex];
                            if (item["appended"]==false||item["appended"]==undefined||item["appended"]==null){
                                appendItem(item);
                                item["appended"]=true;
                            }
                            var itemImg = item[imgKey];
                            var prevItemImg = prevItem[imgKey];
                            //set img to right of screen
                            console.log(item["name"],baseElementWidth*2,baseElementWidth,prevItem["name"],baseElementWidth,0);
                            itemImg.css("margin-left",(baseElementWidth*2));
                            prevItemImg.velocity({
                                marginLeft: 0  
                            },{
                                duration:500,
                                easing:"linear"
                                })
                            itemImg.velocity({
                                marginLeft: baseElementWidth
                            },{
                                duration:500,
                                easing:"linear",
                                complete: function(){
                                    animating=false
                                }
                            });
                            currentIndex = nextIndex;
                        }
                    }
                    
                    function rotateRight(){
                        if (animating == false){
                            animating=true
                            var nextIndex = currentIndex +1;
                            if (nextIndex >= rotatorArray.length){
                                nextIndex = 0;
                            }
                            var prevItem = rotatorArray[currentIndex];
                            var item = rotatorArray[nextIndex];
                            if (item["appended"]==false||item["appended"]==undefined||item["appended"]==null){
                                appendItem(item);
                                item["appended"]=true;
                            }
                            var itemImg = item[imgKey];
                            var prevItemImg = prevItem[imgKey];
                            //set img to left of screen
                            console.log(item["name"],0,baseElementWidth,prevItem["name"],baseElementWidth,baseElementWidth*2);
                            itemImg.css("margin-left",0);
                            prevItemImg.velocity({
                                marginLeft: (baseElementWidth*2)  
                            },{
                                duration:500,
                                easing:"linear"
                                });
                            itemImg.velocity({
                                marginLeft: baseElementWidth
                            },{
                                duration:500,
                                easing:"linear",
                                complete: function(){
                                    animating=false
                                }
                            });
                            currentIndex = nextIndex;
                        }
                    }
                    
                    function appendItem(item){
                        var itemImg = item[imgKey]
                        baseElement.append(itemImg);
                        itemImg.css("margin-left",baseElementWidth*2)
                                .css("position","absolute");
                    }
                    
                    function loadItem(item){
                        appendItem(item);
                        var itemImg = item[imgKey];
                        itemImg.css("margin-left",baseElementWidth)
                                .css("position","absolute");
                    }
                    
                    return {
                        initCarousel:function(elem,array,index,key){
                            rotatorArray = array;
                            currentIndex = index;
                            imgKey = key;
                            baseElementWidth = parseFloat($(elem).css("width"));
                            baseElement = $("<div id='carouselDiv'></div>");
                            baseElement.css("width",baseElementWidth*3)
                                        .css("height",$(elem).css("height"))
                                        .css("overflow","hidden")
                                        .css("position","absolute")
                                        .css("left",parseInt(-baseElementWidth)+"px");
                            $(elem).append(baseElement)
                            loadItem(rotatorArray[index]);
                        },
                        addItem:function(item){
                            rotatorArray.push(item);
                        },
                        removeItem:function(item){
                            var itemIndex = rotatorArray.indexOf(item);
                            if (itemIndex==currentIndex){
                                rotateToIndex(0);
                            }else if (itemIndex < currentIndex){
                                currentIndex -=1;
                            }
                            rotatorArray.splice(itemIndex,1);
                        },
                        rotateToIndex:function(index,direction){
                            if (animating){
                                return false;
                            }else{
                                rotateToIndex(index,direction);
                                return rotatorArray[currentIndex];
                            }
                        },
                        rotateToItem:function(item,direction){
                            if (animating){
                                return false;
                            }else{
                                var itemIndex = rotatorArray.indexOf(item);
                                rotateToIndex(itemIndex,direction);
                                return rotatorArray[currentIndex];
                            }
                        },
                        rotateRight:function(){
                            if (animating){
                                return false;
                            }else{
                                rotateRight();
                                return rotatorArray[currentIndex];
                            }
                        },
                        rotateLeft:function(){
                            if (animating){
                                return false;
                            }else{
                                rotateLeft();
                                return rotatorArray[currentIndex];
                            }
                            
                        },
                        currentItem:function(){
                            return rotatorArray[currentIndex];
                        }
                    }
                })();
                
                var mapArray = [];
                var activeIndex = 0;
                var activeAJAX = 0;
                
                $("document").ready(function(){
                    hideText(1);
                    hideControls(1);
                    fetchAvailableMaps();
                    $("#prevButton").click(leftButtonClick);
                    $("#nextButton").click(rightButtonClick);
                    $("#backButton").click(backToStart);
                    $("#startButton").click(startGame);
                    //load in game to interact with
                    loadElement('gameComponents/game.html','mainGame')
                });
                function backToStart(){
                    loadBackground('gameComponents/maps/'+carousel.currentItem()["name"]+'.png');
                    hideControls(300,function(){showStartScreen();});
                }
                
                function startGame(){
                    hideControls();
                    loadBackground('gameComponents/maps/'+carousel.currentItem()["name"]+'.png');
                    window.game.setMap(carousel.currentItem());
                    removeElement("mapSelector");
                }
                
                function leftButtonClick(){
                    var map = carousel.rotateRight();
                    if (map!==false){
                        hideText();
                        setText(map["name"],map["description"]);
                        showText();
                    }
                    
                }
                function rightButtonClick(){
                    var map = carousel.rotateLeft();
                    if (map!==false){
                        hideText();
                        setText(map["name"],map["description"]);
                        showText();
                    }
                }
                
                function fetchAvailableMaps(){
                    $.ajax({
                        url: 'gameComponents/maps/index.json',
                        type: 'GET',
                        method: 'GET',
                        dataType: "json",
                        success:function(response){
                            for (map of response){
                                addMap(map);
                            }
                        },
                        error:logError
                    });
                }
                
                function addMap(map){
                    activeAJAX+=1;
                    $.ajax({
                        url: 'gameComponents/maps/'+map["name"]+'.mp',
                        type: 'GET',
                        method: 'GET',
                        dataType: "json",
                        success:function(response){
                            map["div"]=$("<img class='carouselImage' id='"+map["name"]+"' src='gameComponents/maps/"+map["name"]+".png'/>")
                            map["mapData"]=response;
                            mapArray.push(map);
                            activeAJAX-=1;
                            console.log(activeAJAX);
                            if (activeAJAX==0){
                                setStartMap(parseBackground());
                            }
                        },
                        error:logError
                    });
                    
                }
                function setText(title,description){
                    $("#mapTitleText").html(title);
                    $("#mapDescriptionText").html(description);
                }
                
                function hideText(duration){
                    if (duration == null || duration == undefined){
                        duration = 300;
                    }
                    $("#textDiv").velocity("transition.slideDownBigOut",duration);
                }
                
                function showText(duration){
                    if (duration == null || duration == undefined){
                        duration = 300;
                    }
                    $("#textDiv").velocity("transition.slideUpBigIn",duration);
                }
                
                function showControls(){
                    $("#infoDiv").velocity("transition.slideUpBigIn",1000);
                    $("#prevButton").velocity("transition.slideLeftBigIn",1000);
                    $("#nextButton").velocity("transition.slideRightBigIn",1000);
                }
                
                function hideControls(duration,callback){
                    if (callback == null || callback == undefined){
                        callback = function(){}
                    }
                    if (duration == null || duration == undefined){
                        duration = 300;
                    }
                    $("#infoDiv").velocity("transition.slideDownBigOut",duration);
                    $("#prevButton").velocity("transition.slideLeftBigOut",duration);
                    $("#nextButton").velocity("transition.slideRightBigOut",{
                        duration:duration,
                        complete:callback   
                    });
                    
                }
                
                function setStartMap(mapName){
                    for (i=0;i<mapArray.length;i++){
                        var map = mapArray[i];
                        console.log(map["name"],mapName);
                        if (map["name"]==mapName){
                            initiateCarousel(i);
                            break;
                        }
                    }
                }
                function initiateCarousel(index){
                    carousel.initCarousel("#mapCarousel",mapArray,index,"div");
                    $("#gameDiv").css("background-image","none");
                    setText(mapArray[index]["name"],mapArray[index]["description"]);
                    showText();
                    showControls();
                }
                
                function parseBackground(){
                    var backgroundPath = $("#gameDiv").css("background-image");
                    backgroundPath = backgroundPath.replace('")','');
                    backgroundPath = backgroundPath.replace('url("','');
                    var pathArray = backgroundPath.split('/');
                    var backgroundName = pathArray[pathArray.length-1];
                    var backgroundMapString = backgroundName.replace('.png','');
                    return backgroundMapString;
                }
                return{
                }
            })();
            

            
        </script>
    </head>
    <body>
        <div class="carousel" id="mapCarousel">
            <button class="carouselButton" id="prevButton">&lt;&lt;</button>
            <button class="carouselButton" id="nextButton">&gt;&gt;</button>
            <div id="infoDiv">
                <div id="textDiv">
                    <div id="mapTitle"><span id="mapTitleText">SomeTitle</span></div>
                    <div id="mapDescription"><span id="mapDescriptionText">SomeDescription very very very very long descriptionbdeiufbidsvfyaodvfouvvuvy avuoyvaoveyu</span></div>
                </div>
                <div id="buttonDiv">
                    <button class="button" id="backButton">Back</button>
                    <button class="button" id="startButton">Play!</button>
                </div>
            </div>
            
        </div>
    </body>
</html>