<html>
    <head>
        <link rel="stylesheet" type="text/css" href="gameComponents/startGameScreen.css">
        <script>
            
            window.startScreen=(function(){
                var noMoreNotifications = false;
                $("document").ready(function(){
                    $("#loggedInLeftBar").fadeOut(0);
                    raiseOverlay(1);
                    //set handlers
                    $("#startButton").click(startPressed);
                    $("#loadGameButton").click(loadPressed);
                    $("#optionsButton").click(optionsPressed);
                    $("#goCreateAccountButton").click(createAccountButtonClicked);
                    $("#createAccountButton").click(createAccount);
                    $("#back").click(backPressed);
                    $("#loginButton").click(login);
                    $("#logoutButton").click(logout);
                    $("#manageAccountButton").click(showAccountManagment);
                    $("#refreshNotifications").click(refreshNotifications);
                    $("#notificationsListContainer").scroll(scrolledNotifications);
                    lowerOverlay();
                    //try logging in
                    if (window.login.isLoggedIn()){
                        //isLoggedIN
                        switchLoggedInWindows();
                        
                    }
                });

                function showAccountManagment(evt){
                    loadElement("gameComponents/accountManagmentScreen.html","accountManagmentScreen");
                }
                
                function lowerOverlay(duration){
                    if (duration == null || duration == undefined){
                        duration = 600;
                    }
                    $("#lowerDiv").velocity("transition.bounceDownIn",{
                        duration:duration
                    })
                }
                
                function raiseOverlay(duration,callback){
                    if (duration == null || duration == undefined){
                        duration = 600;
                    }
                    if (callback == null || callback == undefined){
                        callback = function(){}
                    }
                    $("#lowerDiv").velocity("transition.bounceUpOut",{
                        duration:duration,
                        complete:callback
                    })
                }

                function setAvatar(fileURL){
                    $(".userAvatar").each(function(){
                        console.log(fileURL);
                        console.log($(this));
                        if ($(this).is("img")){
                            $(this).attr("src",fileURL);
                        }else{
                            $(this).attr("background-image","url("+fileURL+")");
                        }

                    });
                }

                function login(evt){
                    lockLoginButtons();
                    var username = $("input[name=userTextbox]").val();
                    var password = $("input[name=passwordTextbox]").val();
                    if (validateUser(username) && validatePassword(password)){
                        window.login.login(username,password,loginHandler);
                    }else{
                        alert("Invalid username or password");  
                        unlockLoginButtons();
                    }
                }
                
                function loginHandler(success,error,errorCode){
                    if (success){
                        $("#usernameSpan").html(window.login.user());
                        window.login.userAvatar(setAvatar);
                        switchLoggedInWindows();
                        //fetch notifications
                        refreshNotifications();
                    }else{
                        alert(error,errorCode);
                    }
                    unlockLoginButtons();
                }

                function switchLoggedInWindows(){
                    //lock buttons
                    lockButtons("button");
                    //switch windows
                    $("#flipContainer").fadeToggle(500);
                    $("#loggedInLeftBar").fadeToggle(500);
                    //reset textboxes
                    $("input[name=passwordTextbox]").val("");
                    $("input[name=userTextboxCreate]").val("");
                    $("input[name=passwordTextboxCreate]").val("");
                    $("input[name=passwordRTextboxCreate]").val("");
                    $("input[name=emailTextboxCreate]").val("");
                    unlockButtons("button");
                }
                function logout(evt){
                    window.login.logout(logoutHandler);
                }
                
                function logoutHandler(success,error,errorCode){
                    if(success){
                        switchLoggedInWindows();
                    }else{
                        alert(error,errorCode);
                    }
                }

                function backPressed(evt){
                    $("#flipper").removeClass('flipped');
                }

                function createAccountButtonClicked(evt){
                    $("#flipper").addClass('flipped');
                }

                function startPressed(evt){
                    //remove all elements
                    raiseOverlay(600,function(){
                        console.log("removed");
                            removeElement("startGameScreen");
                            loadElement("gameComponents/mapSelector.html","mapSelector");});
                }
                function loadPressed(evt){
                    alert("load pressed");
                }
                function optionsPressed(evt){
                    alert("options pressed");
                }
                function createAccount(evt){
                    lockLoginButtons();
                    var username = $("input[name=userTextboxCreate]").val();
                    var password = $("input[name=passwordTextboxCreate]").val();
                    var passwordR = $("input[name=passwordRTextboxCreate]").val();
                    var email = $("input[name=emailTextboxCreate]").val();
                    
                    if (validateAccountCreationDetails(username,password,passwordR,email)){
                        window.login.createAccount(username,password,passwordR,email,createAccountHandler);
                    }else{
                        unlockLoginButtons();
                    }
                    
                }
                
                function createAccountHandler(success,error,errorCode){
                    if (success){
                        alert("Account created. Please log in");
                        backPressed();
                    }else{
                        alert(response["error"],response["errorCode"]);   
                    }
                    unlockLoginButtons();
                }
                
                function validateUser(username){
                    if (username == "" || /^[a-zA-Z0-9]+$/.test(username)==false){
                        return false;
                    }
                    return true;
                }
                function validatePassword(password){
                    if(/\s/g.test(password)||password==""){
                        return false;   
                    }
                    return true;
                }
                function validateAccountCreationDetails(username,password,passwordR,email){
                    //check that username does not breach rules
                    if (validateUser(username)==false){
                        alert("Invalid username entered")
                        return false;   
                    }
                    //check that password does not breach rules
                    if (validatePassword(password)==false || validatePassword(passwordR)==false || password != passwordR){
                        alert("Password is blank or do not match")
                        return false;
                    }
                    //check email does not breach rules
                    if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(email)==false){
                        alert("Invalid email");
                        return false;
                    }
                    return true;
                }

                function clearAllNotifications(){
                    $("#notificationsListContainer").empty();
                }

                function generateNotificationDiv(timestamp,type,title,message,opened){
                    //var unixTimeStamp = new Date(timestamp.replace(' ', 'T')).getTime() / Math.pow(10,3);
                    var notification = $("<div id='" + timestamp + "'></div>");
                    var postDate = new Date(timestamp*1000);
                    notification.addClass("notification");
                    notification.data("timestamp",timestamp);
                    if (opened==true){
                        notification.addClass("opened");
                    }
                    var titleDiv = $("<div class='notificationTitle'>" + title + "</div>");
                    var messageDiv = $("<div class='notificationMessage'>" + message + "</div>");
                    var dateDiv = $("<div class='notificationDate'>" + postDate.toLocaleTimeString()+' '+postDate.toLocaleDateString() + "</div>");
                    notification.append(titleDiv);
                    notification.append(messageDiv);
                    notification.append(dateDiv);

                    //append notification

                    $("#notificationsListContainer").append(notification);
                    var totalHeight = titleDiv.outerHeight(true) + messageDiv.outerHeight(true) + dateDiv.outerHeight(true);
                    notification.height(totalHeight);
                }

                function scrolledNotifications(evt){
                    console.log(noMoreNotifications);
                    if (noMoreNotifications==false){
                        if ($(this).scrollTop() + $(this).innerHeight() >= ($(this)[0].scrollHeight)){
                            //when at bottom
                            //find latest timestamp
                            console.log("loading more");
                            var notification = $("#notificationsListContainer .notification").last()
                            console.log(notification.data("timestamp"));
                            //load 10 more
                            window.login.fetchNotifications(notification.data("timestamp"),10,fetchedNotificationHandler);
                        }
                    }

                }

                function refreshNotifications(){
                    //animate to top
                    $('#notificationsListContainer').velocity({
                        scrollTop:0
                    },200,"swing",function(){
                        $('#notificationsListContainer').velocity("slideUp",200);
                        //clear notifications
                        clearAllNotifications();
                        //load first ten
                        window.login.fetchNotifications(0,10,fetchedNotificationHandler);
                        //reset scroll counter
                        noMoreNotifications=false;
                        $('#notificationsListContainer').velocity("slideDown",200);
                    }); 
                }

                function fetchedNotificationHandler(success,responseData,errorCode){
                    if(success){
                        if (responseData.length==0){
                            noMoreNotifications=true;
                        }else{
                            noMoreNotifications=false;
                        }
                        for (i=0; i < responseData.length; i++){
                            generateNotificationDiv(responseData[i]["timestamp"],responseData[i]["type"],responseData[i]["title"],responseData[i]["message"],responseData[i]["opened"]);
                        }
                    }else{
                        alert(responseData,errorCode);
                    }
                }

                function lockLoginButtons(){
                    lockButtons("#flipContainer button");
                }
                function unlockLoginButtons(){
                    unlockButtons("#flipContainer button");
                }
                
                return{
                    setAvatar: function(fileURL){
                        setAvatar(fileURL);
                    }
                }
            })();
            
            

            
        </script>
    </head>
    <body>
        <div id="lowerDiv">
            <div id="mainOverlay"></div>
            <h1 id="mainTitle">Tower defence</h1>
            <div class="startScreenMainButtons">
                <button id="startButton">Start game</button>
                <button id="loadGameButton">Load game</button>
                <button id="optionsButton">Options</button>
            </div>
            <div id="flipContainer">
                <div id="flipper">
                    <div class="mainPageLoginPanel front">
                        <span class="verticalText right">Login</span>
                        <div id="loginTextBoxes">
                            <span>Username</span>
                            <input type="text" name="userTextbox">
                            <span>Password</span>
                            <input type="password" name="passwordTextbox">
                        </div>
                        <div id="accountLoginButtons">
                            <button id="loginButton">Login</button>
                            <button id="goCreateAccountButton">Create account</button>
                            <button id="forgotUsername">Forgot login details</button>
                        </div>
                    </div>
                    <div class="createAccountPanel back">
                        <span class="verticalText right">Account creation</span>
                        <div id="userEntry">
                            <span>Username</span>
                            <input type="text" name="userTextboxCreate">
                            <span>Password</span>
                            <input type="password" name="passwordTextboxCreate">
                            <span>Repeat Password</span>
                            <input type="password" name="passwordRTextboxCreate">
                            <span>Email</span>
                            <input type="text" name="emailTextboxCreate">
                        </div>
                        <div id="accountCreationButtons">
                            <button id="back">Back</buton>
                            <button id="createAccountButton">Create account</buton>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div id="loggedInLeftBar">
                <div id="loggedInContainer">
                    <img id="userAvatarStart" class = "userAvatar" src="restricted/images/avatars/defaultAvatar.png">
                    <span id="usernameSpan">USERNAME</span>
                    <div id="loggedInContainerButtons">
                        <button id="manageAccountButton" class="loggedInButtons">Manage account</button>
                        <button id="logoutButton" class="loggedInButtons">Logout</button>
                    </div>
                </div>
                <div id="notificationsContainer">
                        <span id="notificationsMainTitle">Notifications</span>
                        <button id="refreshNotifications">Refresh</button>
                    <div id="notificationsListContainer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>