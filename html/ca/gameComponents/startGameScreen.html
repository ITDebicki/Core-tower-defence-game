<html>
    <head>
        <link rel="stylesheet" type="text/css" href="gameComponents/startGameScreen.css">
        <script>
            
            window.loginFunctions=(function(){
                var noMoreNotifications = false;
                $("document").ready(function(){
                    $("#loggedInLeftBar").fadeOut(0);
                    raiseOverlay(1);
                    //set handlers
                    $("#startButton").click(startPressed);
                    $("#loadGameButton").click(loadPressed);
                    $("#optionsButton").click(optionsPressed);
                    $("#goCreateAccountButton").click(createAccountButtonClicked);
                    $("#createAccountButton").click(createAccount);
                    $("#back").click(backPressed);
                    $("#loginButton").click(login);
                    $("#logoutButton").click(logout);
                    $("#manageAccountButton").click(showAccountManagment);
                    $("#refreshNotifications").click(refreshNotifications);
                    $("#notificationsListContainer").scroll(scrolledNotifications);
                    lowerOverlay();
                    //try logging in
                    verifyLoginCredentials(false);
                });

                function showAccountManagment(evt){
                    loadElement("gameComponents/accountManagmentScreen.html","accountManagmentScreen");
                }
                
                function lowerOverlay(duration){
                    if (duration == null || duration == undefined){
                        duration = 600;
                    }
                    $("#lowerDiv").velocity("transition.bounceDownIn",{
                        duration:duration
                    })
                }
                
                function raiseOverlay(duration,callback){
                    if (duration == null || duration == undefined){
                        duration = 600;
                    }
                    if (callback == null || callback == undefined){
                        callback = function(){}
                    }
                    $("#lowerDiv").velocity("transition.bounceUpOut",{
                        duration:duration,
                        complete:callback
                    })
                }

                function fetchUserAvatar(callback){
                    $.ajax({
                        url: 'restricted/performAction.php',
                        type: 'POST',
                        method: 'POST',
                        dataType: "json",
                        data: {"action":"fetchAvatar", "json":"{}"},
                        success:function(response){
                            console.log(response);
                        },
                        error:logError
                    }).done(function(response){
                        console.log(response);
                        var file = null;
                         if (response["success"]==true){
                            var file = response["data"];
                        }else{
                            alert(response["error"],response["errorCode"]);   
                        } 
                        if (file == null || file == ""){
                            file = "defaultAvatar.png";
                        }
                        window._userAvatarSrc = "restricted/images/avatars/" + file;
                        if (!(callback === undefined)){
                            callback();   
                        }
                    });

               }

                function setAvatar(fileURL){
                    if (fileURL === undefined){
                        fileURL = window._userAvatarSrc;   
                    }
                    $(".userAvatar").each(function(){
                        console.log(fileURL);
                        console.log($(this));
                        if ($(this).is("img")){
                            $(this).attr("src",fileURL);
                        }else{
                            $(this).attr("background-image","url("+fileURL+")");
                        }

                    });
                }

                function login(evt){
                    lockLoginButtons();
                    var username = $("input[name=userTextbox]").val();
                    var password = $("input[name=passwordTextbox]").val();
                    if (validateUser(username) && validatePassword(password)){
                        verifyLoginCredentials(true);
                    }else{
                        alert("Invalid username or password");  
                        unlockLoginButtons();
                    }
                }

                function verifyLoginCredentials(showAlert){
                    lockLoginButtons();
                    var username = $("input[name=userTextbox]").val();
                    var password = $("input[name=passwordTextbox]").val();
                    $.ajax({
                            url: 'restricted/login.php',
                            type: 'POST',
                            method: 'POST',
                            dataType: "json",
                            data: {"type":"login", "user":username, "password":password},
                            success:function(response){
                                console.log(response);
                                console.log(response["username"]);
                                if (response["success"]==true){
                                    _user = response["username"]
                                    $("#usernameSpan").html(_user);

                                    fetchUserAvatar(setAvatar);
                                    switchLoggedInWindows();
                                    //fetch notifications
                                    refreshNotifications();

                                }else{
                                    if (showAlert){
                                        alert(response["error"],response["errorCode"]); 
                                    }
                                }
                            },
                            error:logError
                        });
                    unlockLoginButtons();
                }

                function switchLoggedInWindows(){
                    //lock buttons
                    lockButtons("button");
                    //switch windows
                    $("#flipContainer").fadeToggle(500);
                    $("#loggedInLeftBar").fadeToggle(500);
                    //reset textboxes
                    $("input[name=passwordTextbox]").val("");
                    $("input[name=userTextboxCreate]").val("");
                    $("input[name=passwordTextboxCreate]").val("");
                    $("input[name=passwordRTextboxCreate]").val("");
                    $("input[name=emailTextboxCreate]").val("");
                    unlockButtons("button");
                }
                function logout(evt){
                    $.ajax({
                            url: 'restricted/logout.php',
                            dataType: "json",
                            success: function(response){ 
                                console.log(response);
                                if (response["success"]==true){
                                }else{
                                    alert(response["error"],response["errorCode"]);   
                                }
                            },
                            error:logError
                        });
                    switchLoggedInWindows();
                }

                function backPressed(evt){
                    $("#flipper").removeClass('flipped');
                }

                function createAccountButtonClicked(evt){
                    $("#flipper").addClass('flipped');
                }

                function startPressed(evt){
                    //remove all elements
                    raiseOverlay(600,function(){
                        console.log("removed");
                            removeElement("startGameScreen");
                            loadElement("gameComponents/mapSelector.html","mapSelector");});
                }
                function loadPressed(evt){
                    alert("load pressed");
                }
                function optionsPressed(evt){
                    alert("options pressed");
                }
                function createAccount(evt){
                    lockLoginButtons();
                    var username = $("input[name=userTextboxCreate]").val();
                    var password = $("input[name=passwordTextboxCreate]").val();
                    var passwordR = $("input[name=passwordRTextboxCreate]").val();
                    var email = $("input[name=emailTextboxCreate]").val();
                    if (validateAccountCreationDetails(username,password,passwordR,email)){
                        $.ajax({
                            url: 'restricted/login.php',
                            type: 'POST',
                            method: 'POST',
                            dataType: "json",
                            data: { "type": "create", "user":username, "password":password, "passwordR":passwordR, "email":email},
                            success: function(response){ 
                                console.log(response);
                                if (response["success"]==true){
                                    alert("Account created. Please log in");
                                    $("input[name=passwordTextbox]").val("");
                                    $("input[name=userTextboxCreate]").val("");
                                    $("input[name=passwordTextboxCreate]").val("");
                                    $("input[name=passwordRTextboxCreate]").val("");
                                    $("input[name=emailTextboxCreate]").val("");
                                    backPressed();
                                }else{
                                    alert(response["error"],response["errorCode"]);   
                                }
                            },
                            error:logError
                        });
                    }
                    unlockLoginButtons();
                }
                function validateUser(username){
                    if (username == "" || /^[a-zA-Z0-9]+$/.test(username)==false){
                        return false;
                    }
                    return true;
                }
                function validatePassword(password){
                    if(/\s/g.test(password)||password==""){
                        return false;   
                    }
                    return true;
                }
                function validateAccountCreationDetails(username,password,passwordR,email){
                    //check that username does not breach rules
                    if (validateUser(username)==false){
                        alert("Invalid username entered")
                        return false;   
                    }
                    //check that password does not breach rules
                    if (validatePassword(password)==false || validatePassword(passwordR)==false || password != passwordR){
                        alert("Password is blank or do not match")
                        return false;
                    }
                    //check email does not breach rules
                    if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(email)==false){
                        alert("Invalid email");
                        return false;
                    }
                    return true;
                }

                function fetchNotifications(timestamp,limit){
                    $.ajax({
                            url: 'restricted/performAction.php',
                            type: 'POST',
                            method: 'POST',
                            dataType: "json",
                            data: { "action": "fetchNotifications", "json":'{"fromDate":' + timestamp +',"limit":' + limit +'}'},
                            success: function(response){ 
                                console.log(response);
                                if (response["success"]==true){
                                    //append to notifications
                                    console.log("success");
                                    var responseData = response["data"];
                                    if (responseData.length==0){
                                        //no more notifications
                                        noMoreNotifications=true;
                                    }
                                    for (i=0; i < responseData.length; i++){

                                        generateNotificationDiv(responseData[i]["timestamp"],responseData[i]["type"],responseData[i]["title"],responseData[i]["message"],responseData[i]["opened"]);
                                    }
                                }else{
                                    alert(response["error"],response["errorCode"]);   
                                }
                            },
                            error:logError
                        });
                }

                function clearAllNotifications(){
                    $("#notificationsListContainer").empty();
                }

                function generateNotificationDiv(timestamp,type,title,message,opened){
                    //var unixTimeStamp = new Date(timestamp.replace(' ', 'T')).getTime() / Math.pow(10,3);
                    var notification = $("<div id='" + timestamp + "'></div>");
                    var postDate = new Date(timestamp*1000);
                    notification.addClass("notification");
                    notification.data("timestamp",timestamp);
                    if (opened==true){
                        notification.addClass("opened");
                    }
                    var titleDiv = $("<div class='notificationTitle'>" + title + "</div>");
                    var messageDiv = $("<div class='notificationMessage'>" + message + "</div>");
                    var dateDiv = $("<div class='notificationDate'>" + postDate.toLocaleTimeString()+' '+postDate.toLocaleDateString() + "</div>");
                    notification.append(titleDiv);
                    notification.append(messageDiv);
                    notification.append(dateDiv);

                    //append notification

                    $("#notificationsListContainer").append(notification);
                    var totalHeight = titleDiv.outerHeight(true) + messageDiv.outerHeight(true) + dateDiv.outerHeight(true);
                    notification.height(totalHeight);
                }

                function scrolledNotifications(evt){
                    console.log(noMoreNotifications);
                    if (noMoreNotifications==false){
                        if ($(this).scrollTop() + $(this).innerHeight() >= ($(this)[0].scrollHeight)){
                            //when at bottom
                            //find latest timestamp
                            console.log("loading more");
                            var notification = $("#notificationsListContainer .notification").last()
                            console.log(notification.data("timestamp"));
                            //load 10 more
                            fetchNotifications(notification.data("timestamp"),10);
                        }
                    }

                }

                function refreshNotifications(){
                    //animate to top
                    $('#notificationsListContainer').velocity({
                        scrollTop:0
                    },200,"swing",function(){
                        $('#notificationsListContainer').velocity("slideUp",200);
                        //clear notifications
                        clearAllNotifications();
                        //load first ten
                        fetchNotifications(0,10);
                        //reset scroll counter
                        noMoreNotifications=false;
                        $('#notificationsListContainer').velocity("slideDown",200);
                    }); 
                }



                function lockLoginButtons(){
                    lockButtons("#flipContainer button");
                }
                function unlockLoginButtons(){
                    unlockButtons("#flipContainer button");
                }
                
                return{
                    fetchUserAvatar: function(callback){
                        fetchUserAvatar(callback);
                    },
                    setAvatar: function(fileURL){
                        setAvatar(fileURL);
                    }
                }
            })();
            
            

            
        </script>
    </head>
    <body>
        <div id="lowerDiv">
            <div id="mainOverlay"></div>
            <h1 id="mainTitle">Tower defence</h1>
            <div class="startScreenMainButtons">
                <button id="startButton">Start game</button>
                <button id="loadGameButton">Load game</button>
                <button id="optionsButton">Options</button>
            </div>
            <div id="flipContainer">
                <div id="flipper">
                    <div class="mainPageLoginPanel front">
                        <span class="verticalText right">Login</span>
                        <div id="loginTextBoxes">
                            <span>Username</span>
                            <input type="text" name="userTextbox">
                            <span>Password</span>
                            <input type="password" name="passwordTextbox">
                        </div>
                        <div id="accountLoginButtons">
                            <button id="loginButton">Login</button>
                            <button id="goCreateAccountButton">Create account</button>
                            <button id="forgotUsername">Forgot login details</button>
                        </div>
                    </div>
                    <div class="createAccountPanel back">
                        <span class="verticalText right">Account creation</span>
                        <div id="userEntry">
                            <span>Username</span>
                            <input type="text" name="userTextboxCreate">
                            <span>Password</span>
                            <input type="password" name="passwordTextboxCreate">
                            <span>Repeat Password</span>
                            <input type="password" name="passwordRTextboxCreate">
                            <span>Email</span>
                            <input type="text" name="emailTextboxCreate">
                        </div>
                        <div id="accountCreationButtons">
                            <button id="back">Back</buton>
                            <button id="createAccountButton">Create account</buton>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div id="loggedInLeftBar">
                <div id="loggedInContainer">
                    <img id="userAvatarStart" class = "userAvatar" src="restricted/images/avatars/defaultAvatar.png">
                    <span id="usernameSpan">USERNAME</span>
                    <div id="loggedInContainerButtons">
                        <button id="manageAccountButton" class="loggedInButtons">Manage account</button>
                        <button id="logoutButton" class="loggedInButtons">Logout</button>
                    </div>
                </div>
                <div id="notificationsContainer">
                        <span id="notificationsMainTitle">Notifications</span>
                        <button id="refreshNotifications">Refresh</button>
                    <div id="notificationsListContainer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>