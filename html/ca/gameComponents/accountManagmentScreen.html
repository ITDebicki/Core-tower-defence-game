<html>
    <head>
        <link rel="stylesheet" type="text/css" href="gameComponents/accountManagmentScreen.css">
        <script>
            $("document").ready(function(){
                lockButtons("#loggedInContainerButtons");
                //firstly don't show the div
                $("#overlay").fadeOut(0);
                $("#wrapper").fadeOut(0);
                //load all data
                var formdata = false;

                if (window.FormData) {
                    formdata = new FormData();
                }
                $("#avatarImage").attr("src",window._userAvatarSrc);
                
                //set handlers
                //remove overlay
                $("#hideOverlayButton").click(hideOverlay);
                
                //automatic uploading of avatar once submitted
                $("#avatarSelector").change(function() { 
                    if (formdata) {
                        if (this.files[0].size > 1048576 || this.files.length > 1){
                            alert("Please upload one file which is not greater than 2MiB"); 
                        }else{
                            formdata.append("MAX_FILE_SIZE","1048576");
                            formdata.append("userfile[]", this.files[0]);
                            formdata.append("action","uploadAvatar");
                            // select the form and submit
                            $("#avatarUploaderForm").submit();
                        }
                    }
                    
                });
                //avatar uploading
                $("#avatarUploaderForm").submit(function(evt){
                    evt.preventDefault();

                    //send form
                    if (formdata) {
                        $.ajax({
                            url: "restricted/performAction.php",
                            method: "POST",
                            data: formdata,
                            processData: false,
                            contentType: false,
                            dataType: "json",
                            success: function (response) {
                              console.log(response);
                                if (response["success"]==true){
                                    $("#avatarUploadText").removeClass("hover");
                                    loadAvatar();
                                }else{
                                    alert(response["error"],response["errorCode"]);
                                    $("#avatarUploadText").removeClass("hover");
                                }
                            },
                            error:logError
                          });
                    }
                    
                });
                
                //display and hide change avatar on mouse over of avatar
                $("#avatarSelector").mouseover(function(evt){
                    $("#avatarUploadText").addClass("hover"); 
                });
                $("#avatarSelector").mouseout(function(evt){
                    $("#avatarUploadText").removeClass("hover");
                });
                //display and hide change avatar on grabbing a file
                $("#wrapper").on("dragover",function(evt){
                    $("#avatarUploadText").addClass("hover"); 
                });
                $("#wrapper").on("dragleave",function(evt){
                    $("#avatarUploadText").removeClass("hover"); 
                });
                
                //remove avatar
                $("#removeAvatarButton").click(function(evt){
                    if(confirm("Are you sure you want to delete your current avatar?")){
                         $.ajax({
                            url: 'restricted/performAction.php',
                            type: 'POST',
                            method: 'POST',
                            dataType: "json",
                            data: {"action":"removeAvatar", "json":"{}"},
                            success:function(response){
                                console.log(response);
                                if (response["success"]==true){
                                    loadAvatar();
                                    $("#avatarUploadText").removeClass("hover");
                                }else{
                                    alert(response["error"],response["errorCode"]); 
                                }
                            }
                        });   
                    }
                    
                });
                
                //delete account
                $("#deleteAccountButton").click(function(evt){
                    if(confirm("Once you delete your account all your saves and highscores will be deleted. Are you sure you want to proceed?")){
                        $.ajax({
                            url: 'restricted/performAction.php',
                            type: 'POST',
                            method: 'POST',
                            dataType: "json",
                            data: {"action":"deleteAccount", "json":"{}"},
                            success:function(response){
                                console.log(response);
                                if (response["success"]==true){
                                    _user = null;
                                    clearScreenToStartScreen();
                                }else{
                                    alert(response["error"],response["errorCode"]); 
                                }
                            }
                        });   
                    }
                });
                
                //fade back in
                $("#overlay").fadeTo(500,0.9);
                $("#wrapper").fadeIn(500);
                //unlock buttons
                unlockButtons("#loggedInContainerButtons");
            });
            
            
            function hideOverlay(evt){
                $("#wrapper").fadeOut(100,function(){
                    removeElement("accountManagmentScreen")
                });
                
            }
            
            function loadAvatar(){
                fetchUserAvatar(setAvatar);
            }
            
        </script>
    </head>
    <body>
        <div id="wrapper">
            <div id="overlay"></div>
            <div id="avatarImageContainer">
                <img id="avatarImage" class = "userAvatar" src="restricted/images/avatars/defaultAvatar.png">
                <div id="avatarUploadText">
                    <span id="changeAvatarText">Change avatar</span>
                </div>
                <form id="avatarUploaderForm" enctype="multipart/form-data" method="POST" action="restricted/performAction.php">
                    <input type="hidden" name="action" value="uploadAvatar" />
                    <!-- MAX_FILE_SIZE must precede the file input field -->
                    <input type="hidden" name="MAX_FILE_SIZE" value="1048576" />
                    <!-- Name of input element determines name in $_FILES array -->
                    <input id="avatarSelector" name="userfile[]" type="file" />
                </form>
            <button id="removeAvatarButton">Remove avatar</button>
            </div>

        
            <div id="buttonDiv">
                <button id="manage friends">Manage friends</button>
                <button id="viewMyHighScores">View Highscores</button>
                <button id="deleteAllSavesButton">Delete all saves</button>
                <button id="deleteAccountButton">Delete account</button>
                <button id="hideOverlayButton">Back</button>
            </div>
        </div>
    </body>
</html>